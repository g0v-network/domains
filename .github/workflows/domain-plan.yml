on:
  pull_request_target:
    paths:
      - "*.domain/*.yaml"
      - ".github/config-plan-amendment.yml"
      - ".github/workflows/domain-plan.yml"
      - "Pipfile*"

defaults:
  run:
    shell: bash

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  test-and-comment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v2

      - name: Checkout config files from PR
        id: prhead
        run: |
          chmod +x scripts/checkout-pr-config-files.sh
          scripts/checkout-pr-config-files.sh "${{ github.event.pull_request.head.sha }}" "${{ github.event.pull_request.number }}"

      - name: Force HTML plan output
        run: cat .github/config-plan-amendment.yml >> config.yaml

      - uses: actions/setup-python@v2
        with:
          python-version: "3.9"

      - name: Install pipenv
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipenv

      - name: Install octoDNS
        run: make setup

      - name: Generate plan
        run: make dry-run > octodns-sync.plan

      - name: Get plan output
        id: plan
        run: |
          chmod +x scripts/parse-plan-output.sh
          scripts/parse-plan-output.sh "${GITHUB_WORKSPACE}/octodns-sync.plan"

      - name: Find Comment
        uses: peter-evans/find-comment@v1
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: Automatically generated by octodns-sync

      - name: Add or update PR comment
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body: |
            ## OctoDNS Plan for `${{ steps.prhead.outputs.sha }}`
            ${{ steps.plan.outputs.plan }}
            Automatically generated by octodns-sync
          edit-mode: replace
